<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Mercury AR</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdn.rawgit.com/jeromeetienne/AR.js/2.2.1/aframe/build/aframe-ar.js"></script>
    <link rel="stylesheet" href="planet-styles.css">
    <script>
      AFRAME.registerComponent('planet-interaction', {
        init: function () {
          const el = this.el;
          const scene = el.sceneEl;
          const originalPosition = el.getAttribute('position') || {x:0,y:0,z:0};
          let lastX, lastY, isDragging = false;
          let currentRotation = {x:0,y:0};
          let currentScale = 1;
          let startDist = null, startScale = null, startRot = null;

          const setup = () => {
            if (!scene || !scene.camera || !scene.canvas) return setTimeout(setup, 100);
            const canvas = scene.canvas;
            // Make sure the model always stays anchored to the marker position
            el.setAttribute('position', `${originalPosition.x} ${originalPosition.y} ${originalPosition.z}`);
            el.object3D.userData.isDragging = false;

            function getPointer(e){ return (e.touches && e.touches.length)? e.touches[0] : e; }

            canvas.addEventListener('mousedown', (e)=>{ isDragging=true; el.object3D.userData.isDragging = true; lastX=e.clientX; lastY=e.clientY; startRot={...currentRotation}; });
            window.addEventListener('mousemove', (e)=>{ if(!isDragging) return; let dx=e.clientX-lastX; let dy=e.clientY-lastY; currentRotation.y = startRot.y + dx*0.5; currentRotation.x = startRot.x - dy*0.5; el.setAttribute('rotation', `${currentRotation.x} ${currentRotation.y} 0`); });
            window.addEventListener('mouseup', ()=>{ isDragging=false; el.object3D.userData.isDragging = false; });

            canvas.addEventListener('wheel', (e)=>{ e.preventDefault(); currentScale += e.deltaY < 0 ? 0.1 : -0.1; currentScale = Math.max(0.2, Math.min(3, currentScale)); el.setAttribute('scale', `${currentScale} ${currentScale} ${currentScale}`); });

            canvas.addEventListener('touchstart', (e)=>{
              if (e.touches.length===2){ startDist = Math.hypot(e.touches[0].clientX-e.touches[1].clientX, e.touches[0].clientY-e.touches[1].clientY); startScale=currentScale; }
              else { isDragging=true; el.object3D.userData.isDragging = true; lastX=e.touches[0].clientX; lastY=e.touches[0].clientY; startRot={...currentRotation}; }
            }, {passive:false});

            canvas.addEventListener('touchmove', (e)=>{
              if (e.touches.length===2 && startDist){ let newDist=Math.hypot(e.touches[0].clientX-e.touches[1].clientX, e.touches[0].clientY-e.touches[1].clientY); let scaleChange=newDist/startDist; currentScale = Math.max(0.2, Math.min(3, startScale*scaleChange)); el.setAttribute('scale', `${currentScale} ${currentScale} ${currentScale}`); }
              else if (e.touches.length===1 && isDragging){ let dx=e.touches[0].clientX-lastX; let dy=e.touches[0].clientY-lastY; currentRotation.y = startRot.y + dx*0.5; currentRotation.x = startRot.x - dy*0.5; el.setAttribute('rotation', `${currentRotation.x} ${currentRotation.y} 0`); }
            }, {passive:false});

            canvas.addEventListener('touchend', (e)=>{ if (e.touches.length<2) startDist=null; if (e.touches.length===0) { isDragging=false; el.object3D.userData.isDragging = false; } });

            // simple tap to toggle info label using raycast
            const raycaster = new THREE.Raycaster();
            const mouse = new THREE.Vector2();
            function computeMouse(ev){ const rect=canvas.getBoundingClientRect(); mouse.x = ((ev.clientX-rect.left)/rect.width)*2-1; mouse.y = -((ev.clientY-rect.top)/rect.height)*2+1; }
            canvas.addEventListener('click', (e)=>{
              computeMouse(e); raycaster.setFromCamera(mouse, scene.camera);
              const objs = raycaster.intersectObject(el.object3D, true);
              if (objs.length>0){ const label = el.parentEl.querySelector('#info'); if (label){ const vis = label.getAttribute('visible'); label.setAttribute('visible', !vis); } }
            });
          };
          setup();
        },
        // Hard-lock the model to its original position each frame (no translation)
        tick: function(time, delta){
          // Always keep the model anchored to the marker origin (no translation)
          const el = this.el;
          if (!el) return;
          el.object3D.position.set(0, 0, 0);

          // Gentle auto-rotation when not dragging
          if (!el.object3D.userData.isDragging) {
            const rot = el.getAttribute('rotation') || {x:0,y:0,z:0};
            const speed = 12; // degrees per second
            const step = (delta || 16) * (speed / 1000);
            el.setAttribute('rotation', `${rot.x} ${rot.y + step} ${rot.z}`);
          }
        }
      });
    </script>
  </head>
  <body style="margin:0; overflow:hidden;">
    <div id="loadingScreen" class="loading-screen">
      <div class="loading-spinner"></div>
      <div class="loading-text">Loading Planet AR</div>
      <div class="loading-subtext">Please allow camera access</div>
    </div>

    <div class="constellation-header">
      <div class="header-content">
        <div>
          <div class="constellation-title">ü™ê Mercury</div>
          <div class="constellation-subtitle">Interactive AR Planet</div>
        </div>
        <div class="status-indicator">
          <div id="statusDot" class="status-dot"></div>
          <div id="statusText" class="status-text">Scanning...</div>
        </div>
      </div>
    </div>

    <div class="control-panel">
      <div class="control-title">Controls</div>
      <div class="control-buttons">
        <button class="control-btn" onclick="toggleLabel()">Toggle Label</button>
        <button class="control-btn" onclick="resetPlanet()">Reset View</button>
        <button class="control-btn" onclick="stopAudio()">‚èπ Stop Audio</button>
      </div>
    </div>

    <div class="instructions-panel">
      <div class="instructions-title">How to Use</div>
      <div class="instruction-item"><div class="instruction-icon">1</div><span>Point camera at Mercury marker</span></div>
      <div class="instruction-item"><div class="instruction-icon">2</div><span>Drag to rotate, wheel/pinch to zoom</span></div>
      <div class="instruction-item"><div class="instruction-icon">3</div><span>Click planet to toggle label</span></div>
    </div>

    <div id="infoBox" class="info-panel" style="display:none;">
      <button class="info-close" onclick="document.getElementById('infoBox').style.display='none'">√ó</button>
      <div class="info-title">Mercury Facts</div>
      <div class="info-content">Mercury is the smallest planet and closest to the Sun. A year on Mercury is just 88 Earth days.</div>
      <div class="info-details">Tip: Use two fingers to zoom on mobile. Use your mouse wheel on desktop.</div>
    </div>

    <a-scene embedded arjs="sourceType: webcam;" renderer="logarithmicDepthBuffer: true;">
      <a-entity light="type: ambient; color: #888"></a-entity>
      <a-entity light="type: point; intensity: 1" position="0 2 2"></a-entity>

      <a-entity position="0 0 0">
        <a-marker type="pattern" url="./markers/mercury.patt">
          <a-entity>
            <a-sphere id="mercury" class="clickable" planet-interaction
              radius="0.3" material="src: url(./texture/mercury.jpg)">
            </a-sphere>
            <a-entity id="info" visible="false" position="0 -0.7 0" text="value: Mercury: Closest planet to the Sun.; color: #fff; align: center"></a-entity>
          </a-entity>
        </a-marker>
      </a-entity>
    </a-scene>
    <script>
      // UI helpers
      const statusDot = document.getElementById('statusDot');
      const statusText = document.getElementById('statusText');
      const loadingScreen = document.getElementById('loadingScreen');
      const infoBox = document.getElementById('infoBox');
      function updateStatus(text, active){ if(statusText) statusText.textContent=text; if(statusDot) statusDot.classList.toggle('active',!!active); }
      function hideLoading(){ if(loadingScreen) loadingScreen.style.display='none'; }
      function toggleLabel(){ const el=document.querySelector('#info'); if(el){ el.setAttribute('visible', !(el.getAttribute('visible'))); } }
      function resetPlanet(){ const m=document.querySelector('#mercury'); if(m){ m.setAttribute('rotation','0 0 0'); m.setAttribute('scale','1 1 1'); } }
      function speak(text){ if('speechSynthesis' in window){ speechSynthesis.cancel(); const u=new SpeechSynthesisUtterance(text); u.lang='en-US'; u.rate=0.95; u.pitch=1; speechSynthesis.speak(u);} }
      function readFacts(){ speak('Mercury is the smallest planet and the closest to the Sun. A year on Mercury lasts eighty eight Earth days. Its surface is heavily cratered and it has almost no atmosphere.'); }
      function stopAudio(){ if('speechSynthesis' in window){ speechSynthesis.cancel(); } }

      // Show info after detection
      document.addEventListener('DOMContentLoaded', ()=>{
        setTimeout(()=>{
          const marker=document.querySelector('a-marker');
          if(marker){
            marker.addEventListener('markerFound', ()=>{ updateStatus('Planet Detected!', true); hideLoading(); infoBox.style.display='block'; readFacts(); });
            marker.addEventListener('markerLost', ()=>{ updateStatus('Scanning...', false); });
          }
          setTimeout(()=>{ if(loadingScreen && loadingScreen.style.display!=='none'){ hideLoading(); updateStatus('Ready to Scan', false);} }, 2500);
        }, 800);
      });
    </script>
  </body>
</html>